<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>show product</title>
    <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../node_modules/@fortawesome/fontawesome-free/css/all.css">
    <script src="../../node_modules/axios/dist/axios.min.js"></script>
    <script src="../../node_modules/sweetalert/dist/sweetalert.min.js"></script>

</head>
<body>

<nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
    <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">NGO VAN LONG</a>
</nav>
<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 sidebar bg-secondary">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item"><a href="#" class="text-light nav-link active"><i class="fas fa-box-open"></i>
                        PRODUCTS</a></li>
                </ul>
            </div>
        </nav>
        <div class="col-md-9 ml-sm-auto col-lg-10">
            <div>
                <h3>List Products</h3>
            </div>
            <div>
                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col">Name</th>
                        <th scope="col">image</th>
                        <th scope="col">cate</th>
                        <th scope="col">price</th>
                        <th scope="col">handle</th>
                        <th scope="col">
                            <a href="editProduct.html" type="button" class="btn btn-success">Thêm</a>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="tbodyProdcut">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="../../node_modules/lodash/lodash.js"></script>
<script src="../../node_modules/jquery/dist/jquery.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="../../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

<script>

    // import
    // end import

    dd = (x) => console.log(x);

    var tbodyProduct = document.querySelector('#tbodyProdcut');
    showProduct = (array) => {
        // in ra table - su dung foreach
        _.forEach(array, (value) => {
            tbodyProduct.innerHTML += `
                    <tr>
                      <td>${value.name}</td>
                      <td><img src="${value.image}" width="100" alt=""></td>
                      <td>cate</td>
                      <td>${value.price}</td>
                      <td>${value.detail}</td>
                      <td>
                        <button type="button" id="removeProduct" onclick="removeProduct(${value.id}, ${value.categoryId})" class="btn btn-danger">Delete</button>
                        <a type="button" href="editProduct.html" onclick="editProduct(${value.id}, ${value.categoryId})" class="btn btn-success">Edit</a>
                      </td>
                    </tr>
                `
        });
    }

    const url = 'http://5e79bb5b17314d00161335e8.mockapi.io';
    let pro = [];
    // lấy data tất cả products
    axios.get(`${url}/category`)
        .then(response => response.data)
        .then(cate => Promise.all(
            _.map(cate, category => axios.get(`${url}/category/${category.id}/products`))
            )
        )
        .then(product => {
            _.forEach(product, (value, index) => {
                _.forEach(value.data, (x, y) => {
                    pro.push(x);
                })
            });
            showProduct(pro);
        });

    // remove product

    removeProduct = (id, categoryId) => {
        swal({
            title: "Are you sure?",
            text: "Once deleted, you will not be able to recover this imaginary file!",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        })
            .then((willDelete) => {
                if (willDelete) {
                    tbodyProduct.innerHTML = ''; // vì trên kia dùng += lên giờ mới phải để nó 'rỗng'
                    _.remove(pro, (value) => value.id === id); // xóa phần tử trong mảng
                    showProduct(pro); // rồi cho hiển thị lại.
                    let urlRemove = `http://5e79bb5b17314d00161335e8.mockapi.io/category/${categoryId}/products/${id}`;
                    axios.delete(urlRemove)
                        .then(function (response) {
                            // handle success
                        })
                        .catch(function (error) {
                            // handle error
                            console.log(error);
                        })
                        .then(function () {
                            // always executed
                        });

                    swal("Poof! Your imaginary file has been deleted!", {
                        icon: "success",
                    });
                } else {
                    swal("Your imaginary file is safe!");
                }
            });
    };

    // edit product

    editProduct = (id, idCategories) => {
        function obj(idPro, idCate) {
            this.idPro = idPro;
            this.idCate = idCate;
        }

        let pro = new obj(id, idCategories);

        console.log(pro);

        localStorage.setItem('products', JSON.stringify(pro));
    };


    // edit thanh cong thi hien thị thông bóa
    window.location.href.replace(location.hash, '').replace(
        /[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
        function (m, key, value) { // callback
            if (value === 'true' && key === 'edit') {
                swal({
                    title: "Good job!",
                    text: "Edit product success!",
                    icon: "success",
                    button: "Aww yiss!",
                });
            }
        }
    );

    // edit thanh cong


</script>
</body>
</html>
